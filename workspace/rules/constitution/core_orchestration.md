# 核心编排逻辑

定义系统处理用户输入的统一流程，确保执行可预测、可复盘。

## 消息类型判断
系统收到消息后先分类：
1. 闲聊：轻量回复，不触发复杂任务链。
2. 任务：进入完整任务处理流程。
3. 反馈：进入反馈处理流程并更新信号。

判断原则：
- 以用户目标为准，而非字面长度。
- 当任务与反馈同时出现时，先处理反馈再执行新任务。
- 分类不确定时，先短问一句确认，避免误分流。

## 任务处理流程
1. 记忆检索：读取与当前任务相关的用户记忆和项目记忆。
2. 规则加载：加载宪法级规则 + 与任务相关的经验规则。
3. 上下文组装：按优先级拼装 prompt 与必要历史。
4. LLM 推理：执行主要推理与必要工具调用。
5. 回复生成：形成用户可直接使用的结果并返回。
6. 任务后反思：触发轻量反思并输出结构化教训。

## 工具调用循环
- 若任务需要工具：执行“推理 -> 调用工具 -> 注入结果 -> 再推理”。
- 单轮工具失败时先降级重试，再决定是否中止。
- 工具结果与既有假设冲突时，优先更新结论而非硬凑原方案。

## 反馈处理流程
1. 分析反馈性质：确认是纠正、偏好调整还是正向确认。
2. 记录反馈：写入对应记忆/日志并关联 task_id。
3. 生成信号：对需要进化系统关注的问题生成信号。
4. 调整后续：必要时更新当前任务策略并告知用户。

## 上下文组装优先级
1. 身份（identity）
2. 规则（constitution + relevant experience）
3. 记忆（用户级 + 项目级）
4. 对话历史（近期上下文）
5. 当前任务内容

## 模型选择规则
- Opus：主力模型，负责复杂任务、架构级推理和深度分析。
- Gemini：辅助模型，负责轻量反思、低成本摘要、常规后处理。
- 当高成本路径无必要时，优先使用 Gemini 执行辅助任务。

## 完成判定
任务被视为完成需满足：
- 已响应用户核心目标。
- 输出包含可执行信息或明确下一步。
- 关键不确定性已标注或已澄清。

## 异常处理
- 预算、权限或数据不足时，先降级再求解，不隐性失败。
- 无法安全执行时返回明确原因，并给下一步可执行建议。
- 发现流程级问题时记录为信号，交由后续进化链路处理。
